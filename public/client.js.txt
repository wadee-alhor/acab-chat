const socket = io();
let username;
let room;
let localStream;
let peer;

function joinRoom() {
    username = document.getElementById("username").value;
    room = document.getElementById("room").value;

    socket.emit("join-room", room, username);

    document.getElementById("login").style.display = "none";
    document.getElementById("chat").style.display = "block";
}

function sendMessage() {
    const message = document.getElementById("messageInput").value;
    socket.emit("send-message", { room, username, message });
}

socket.on("message", (msg) => {
    const div = document.createElement("div");
    div.innerText = msg;
    document.getElementById("messages").appendChild(div);
});

async function startVoice() {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    peer = new RTCPeerConnection();

    localStream.getTracks().forEach(track => {
        peer.addTrack(track, localStream);
    });

    peer.onicecandidate = (event) => {
        if (event.candidate) {
            socket.emit("voice-signal", { room, signal: event.candidate });
        }
    };

    socket.on("voice-signal", async (signal) => {
        await peer.addIceCandidate(new RTCIceCandidate(signal));
    });
}