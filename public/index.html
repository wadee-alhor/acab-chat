<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø´Ø§Øª Ø²ÙˆÙ†</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Cairo', sans-serif; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #2f3136; }
    ::-webkit-scrollbar-thumb { background: #202225; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #18191c; }
    .message-hover:hover { background: rgba(79, 84, 92, 0.16); }
    .server-icon:hover { border-radius: 35%; }
    .server-icon { transition: border-radius 0.2s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-slide { animation: slideIn 0.3s ease; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .animate-pulse { animation: pulse 2s infinite; }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full bg-gray-900 text-gray-100 overflow-hidden">
  <div id="app" class="h-full w-full"></div>
  <script>
    // Default Configuration
    const defaultConfig = {
      app_title: 'Ø´Ø§Øª Ø²ÙˆÙ†',
      welcome_message: 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø´Ø§Øª Ø²ÙˆÙ†',
      primary_color: '#5865F2',
      secondary_color: '#3ba55c',
      background_color: '#36393f',
      surface_color: '#2f3136',
      text_color: '#dcddde'
    };

    let config = { ...defaultConfig };

    // App State
    let currentUser = null;
    let allData = [];
    let currentView = 'auth';
    let currentServer = null;
    let currentChannel = null;
    let showProfileModal = false;
    let showCreateServerModal = false;
    let showAddFriendModal = false;

    // Initialize SDKs
    async function initApp() {
      // Initialize Element SDK
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...config, ...newConfig };
            render();
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [
              { get: () => cfg.background_color || defaultConfig.background_color, set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); }},
              { get: () => cfg.surface_color || defaultConfig.surface_color, set: (v) => { cfg.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }},
              { get: () => cfg.text_color || defaultConfig.text_color, set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); }},
              { get: () => cfg.primary_color || defaultConfig.primary_color, set: (v) => { cfg.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); }},
              { get: () => cfg.secondary_color || defaultConfig.secondary_color, set: (v) => { cfg.secondary_color = v; window.elementSdk.setConfig({ secondary_color: v }); }}
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['app_title', cfg.app_title || defaultConfig.app_title],
            ['welcome_message', cfg.welcome_message || defaultConfig.welcome_message]
          ])
        });
      }

      // Initialize Data SDK
      if (window.dataSdk) {
        const result = await window.dataSdk.init({
          onDataChanged: (data) => {
            allData = data;
            checkUserSession();
            render();
          }
        });
        if (!result.isOk) {
          console.error('Failed to initialize Data SDK');
        }
      }

      render();
    }

    function checkUserSession() {
      const savedUserId = localStorage.getItem('chatzone_user_id');
      if (savedUserId && !currentUser) {
        const user = allData.find(d => d.type === 'user' && d.__backendId === savedUserId);
        if (user) {
          currentUser = user;
          currentView = 'main';
        }
      }
    }

    // Helper Functions
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function getUsers() {
      return allData.filter(d => d.type === 'user');
    }

    function getServers() {
      return allData.filter(d => d.type === 'server');
    }

    function getChannels(serverId) {
      return allData.filter(d => d.type === 'channel' && d.serverId === serverId);
    }

    function getMessages(channelId) {
      return allData.filter(d => d.type === 'message' && d.channelId === channelId)
        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    }

    function getFriends() {
      return allData.filter(d => d.type === 'friend' && d.senderId === currentUser?.__backendId);
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
    }

    // Auth Functions
    async function handleRegister(e) {
      e.preventDefault();
      const form = e.target;
      const username = form.username.value.trim();
      const email = form.email.value.trim();
      const password = form.password.value;

      if (!username || !email || !password) {
        showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
        return;
      }

      const existingUser = allData.find(d => d.type === 'user' && d.email === email);
      if (existingUser) {
        showToast('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        return;
      }

      const btn = form.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.innerHTML = '<span class="animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...</span>';

      const result = await window.dataSdk.create({
        type: 'user',
        username,
        email,
        password,
        avatar: 'ğŸ‘¤',
        status: 'online',
        statusText: 'Ù…ØªØµÙ„',
        createdAt: new Date().toISOString()
      });

      btn.disabled = false;
      btn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';

      if (result.isOk) {
        showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'success');
        document.getElementById('auth-tab-login').click();
      } else {
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨', 'error');
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      const form = e.target;
      const email = form.email.value.trim();
      const password = form.password.value;

      const user = allData.find(d => d.type === 'user' && d.email === email && d.password === password);
      
      if (user) {
        currentUser = user;
        localStorage.setItem('chatzone_user_id', user.__backendId);
        currentView = 'main';
        showToast('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ!', 'success');
        render();
      } else {
        showToast('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
      }
    }

    function handleLogout() {
      currentUser = null;
      currentServer = null;
      currentChannel = null;
      localStorage.removeItem('chatzone_user_id');
      currentView = 'auth';
      render();
    }

    // Server Functions
    async function createServer(name, icon) {
      if (allData.length >= 999) {
        showToast('ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        return;
      }

      const serverId = generateId();
      const result = await window.dataSdk.create({
        type: 'server',
        serverId,
        serverName: name,
        serverIcon: icon || 'ğŸ®'
      });

      if (result.isOk) {
        // Create default channel
        await window.dataSdk.create({
          type: 'channel',
          channelId: generateId(),
          channelName: 'Ø¹Ø§Ù…',
          serverId
        });
        showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        showCreateServerModal = false;
        render();
      }
    }

    // Message Functions
    async function sendMessage(content) {
      if (!content.trim() || !currentChannel || !currentUser) return;

      if (allData.length >= 999) {
        showToast('ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', 'error');
        return;
      }

      const result = await window.dataSdk.create({
        type: 'message',
        messageId: generateId(),
        messageContent: content,
        channelId: currentChannel.channelId,
        senderId: currentUser.__backendId,
        senderName: currentUser.username,
        timestamp: new Date().toISOString()
      });

      if (result.isOk) {
        document.getElementById('message-input').value = '';
        setTimeout(() => {
          const container = document.getElementById('messages-container');
          if (container) container.scrollTop = container.scrollHeight;
        }, 100);
      }
    }

    // Profile Functions
    async function updateProfile(field, value) {
      if (!currentUser) return;

      const updatedUser = { ...currentUser, [field]: value };
      const result = await window.dataSdk.update(updatedUser);
      
      if (result.isOk) {
        currentUser = updatedUser;
        showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', 'success');
        render();
      }
    }

    // Friend Functions
    async function addFriend(friendName) {
      if (!friendName.trim()) return;

      const friend = allData.find(d => d.type === 'user' && d.username === friendName && d.__backendId !== currentUser.__backendId);
      
      if (!friend) {
        showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
        return;
      }

      const existingFriend = allData.find(d => d.type === 'friend' && d.senderId === currentUser.__backendId && d.friendId === friend.__backendId);
      if (existingFriend) {
        showToast('Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰', 'error');
        return;
      }

      const result = await window.dataSdk.create({
        type: 'friend',
        senderId: currentUser.__backendId,
        friendId: friend.__backendId,
        friendName: friend.username,
        friendAvatar: friend.avatar,
        friendStatus: friend.status
      });

      if (result.isOk) {
        showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµØ¯ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        showAddFriendModal = false;
        render();
      }
    }

    // Toast Notification
    function showToast(message, type = 'info') {
      const existing = document.getElementById('toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.id = 'toast';
      toast.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 animate-slide ${
        type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'
      } text-white font-semibold`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }

    // Render Functions
    function render() {
      const app = document.getElementById('app');
      
      if (currentView === 'auth') {
        renderAuth(app);
      } else {
        renderMain(app);
      }
    }

    function renderAuth(container) {
      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      container.innerHTML = `
        <div class="h-full w-full flex items-center justify-center p-4" style="background: linear-gradient(135deg, ${bgColor} 0%, #202225 100%);">
          <div class="w-full max-w-md rounded-2xl shadow-2xl overflow-hidden" style="background: ${surfaceColor};">
            <div class="p-8">
              <div class="text-center mb-8">
                <div class="text-6xl mb-4">ğŸ’¬</div>
                <h1 class="text-3xl font-bold" style="color: ${textColor};">${config.app_title || defaultConfig.app_title}</h1>
                <p class="mt-2 opacity-70" style="color: ${textColor};">${config.welcome_message || defaultConfig.welcome_message}</p>
              </div>

              <div class="flex mb-6 rounded-lg overflow-hidden" style="background: ${bgColor};">
                <button id="auth-tab-login" onclick="switchAuthTab('login')" class="flex-1 py-3 font-semibold transition auth-tab active" style="background: ${primaryColor}; color: white;">
                  ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                </button>
                <button id="auth-tab-register" onclick="switchAuthTab('register')" class="flex-1 py-3 font-semibold transition auth-tab" style="color: ${textColor};">
                  Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
                </button>
              </div>

              <div id="login-form">
                <form onsubmit="handleLogin(event)" class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium mb-2" style="color: ${textColor};">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" name="email" required class="w-full px-4 py-3 rounded-lg focus:outline-none focus:ring-2" style="background: ${bgColor}; color: ${textColor}; border: 1px solid #4f545c;" placeholder="example@email.com">
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2" style="color: ${textColor};">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" name="password" required class="w-full px-4 py-3 rounded-lg focus:outline-none focus:ring-2" style="background: ${bgColor}; color: ${textColor}; border: 1px solid #4f545c;" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                  </div>
                  <button type="submit" class="w-full py-3 rounded-lg font-semibold transition hover:opacity-90" style="background: ${primaryColor}; color: white;">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                  </button>
                </form>
              </div>

              <div id="register-form" class="hidden">
                <form onsubmit="handleRegister(event)" class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium mb-2" style="color: ${textColor};">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                    <input type="text" name="username" required class="w-full px-4 py-3 rounded-lg focus:outline-none focus:ring-2" style="background: ${bgColor}; color: ${textColor}; border: 1px solid #4f545c;" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2" style="color: ${textColor};">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" name="email" required class="w-full px-4 py-3 rounded-lg focus:outline-none focus:ring-2" style="background: ${bgColor}; color: ${textColor}; border: 1px solid #4f545c;" placeholder="example@email.com">
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2" style="color: ${textColor};">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" name="password" required class="w-full px-4 py-3 rounded-lg focus:outline-none focus:ring-2" style="background: ${bgColor}; color: ${textColor}; border: 1px solid #4f545c;" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                  </div>
                  <button type="submit" class="w-full py-3 rounded-lg font-semibold transition hover:opacity-90" style="background: ${primaryColor}; color: white;">
                    Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function switchAuthTab(tab) {
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');
      const loginTab = document.getElementById('auth-tab-login');
      const registerTab = document.getElementById('auth-tab-register');
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      if (tab === 'login') {
        loginForm.classList.remove('hidden');
        registerForm.classList.add('hidden');
        loginTab.style.background = primaryColor;
        loginTab.style.color = 'white';
        registerTab.style.background = 'transparent';
        registerTab.style.color = textColor;
      } else {
        loginForm.classList.add('hidden');
        registerForm.classList.remove('hidden');
        registerTab.style.background = primaryColor;
        registerTab.style.color = 'white';
        loginTab.style.background = 'transparent';
        loginTab.style.color = textColor;
      }
    }

    function renderMain(container) {
      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const servers = getServers();
      const channels = currentServer ? getChannels(currentServer.serverId) : [];
      const messages = currentChannel ? getMessages(currentChannel.channelId) : [];
      const friends = getFriends();

      container.innerHTML = `
        <div class="h-full w-full flex">
          <!-- Server Sidebar -->
          <div class="w-18 flex-shrink-0 flex flex-col items-center py-3 space-y-2 overflow-y-auto" style="background: #202225;">
            <!-- Home Button -->
            <button onclick="currentServer = null; currentChannel = null; render();" class="w-12 h-12 rounded-2xl flex items-center justify-center text-2xl transition server-icon hover:rounded-xl ${!currentServer ? 'ring-2 ring-white' : ''}" style="background: ${primaryColor};">
              ğŸ 
            </button>
            <div class="w-8 h-0.5 rounded-full bg-gray-700"></div>
            
            <!-- Servers -->
            ${servers.map(server => `
              <button onclick="selectServer('${server.serverId}')" class="w-12 h-12 rounded-full flex items-center justify-center text-2xl transition server-icon hover:rounded-xl ${currentServer?.serverId === server.serverId ? 'ring-2 ring-white rounded-xl' : ''}" style="background: ${surfaceColor};">
                ${server.serverIcon}
              </button>
            `).join('')}
            
            <!-- Add Server -->
            <button onclick="showCreateServerModal = true; render();" class="w-12 h-12 rounded-full flex items-center justify-center text-2xl transition server-icon hover:rounded-xl" style="background: ${surfaceColor}; color: ${secondaryColor};">
              +
            </button>
          </div>

          <!-- Channel Sidebar -->
          <div class="w-60 flex-shrink-0 flex flex-col" style="background: ${surfaceColor};">
            <div class="p-4 shadow-md">
              <h2 class="font-bold text-lg" style="color: ${textColor};">${currentServer?.serverName || 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'}</h2>
            </div>
            
            <div class="flex-1 overflow-y-auto p-2">
              ${currentServer ? `
                <div class="mb-4">
                  <div class="flex items-center justify-between px-2 mb-2">
                    <span class="text-xs font-semibold uppercase opacity-70" style="color: ${textColor};">Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù†ØµÙŠØ©</span>
                    <button onclick="createChannel()" class="opacity-70 hover:opacity-100" style="color: ${textColor};">+</button>
                  </div>
                  ${channels.map(channel => `
                    <button onclick="selectChannel('${channel.channelId}')" class="w-full text-right px-2 py-1.5 rounded transition ${currentChannel?.channelId === channel.channelId ? 'bg-opacity-20' : 'hover:bg-opacity-10'}" style="background: ${currentChannel?.channelId === channel.channelId ? primaryColor : 'transparent'}; color: ${textColor};">
                      # ${channel.channelName}
                    </button>
                  `).join('')}
                </div>
              ` : `
                <div class="mb-4">
                  <div class="px-2 mb-2">
                    <span class="text-xs font-semibold uppercase opacity-70" style="color: ${textColor};">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</span>
                  </div>
                  ${friends.length > 0 ? friends.map(friend => `
                    <div class="flex items-center gap-3 px-2 py-2 rounded hover:bg-opacity-10 transition cursor-pointer" style="background: transparent; color: ${textColor};">
                      <div class="relative">
                        <span class="text-2xl">${friend.friendAvatar || 'ğŸ‘¤'}</span>
                        <span class="absolute -bottom-1 -right-1 w-3 h-3 rounded-full border-2" style="background: ${secondaryColor}; border-color: ${surfaceColor};"></span>
                      </div>
                      <span class="font-medium">${friend.friendName}</span>
                    </div>
                  `).join('') : `
                    <p class="px-2 text-sm opacity-50" style="color: ${textColor};">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯</p>
                  `}
                  <button onclick="showAddFriendModal = true; render();" class="w-full mt-2 px-2 py-2 rounded text-sm font-medium transition hover:bg-opacity-10" style="color: ${secondaryColor};">
                    + Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚
                  </button>
                </div>
              `}
            </div>

            <!-- User Info -->
            <div class="p-2 flex items-center gap-2" style="background: #292b2f;">
              <button onclick="showProfileModal = true; render();" class="flex items-center gap-2 flex-1 p-2 rounded hover:bg-opacity-10 transition" style="background: transparent;">
                <div class="relative">
                  <span class="text-3xl">${currentUser?.avatar || 'ğŸ‘¤'}</span>
                  <span class="absolute -bottom-1 -right-1 w-3.5 h-3.5 rounded-full border-2" style="background: ${currentUser?.status === 'online' ? secondaryColor : currentUser?.status === 'idle' ? '#faa61a' : currentUser?.status === 'dnd' ? '#ed4245' : '#747f8d'}; border-color: #292b2f;"></span>
                </div>
                <div class="text-right">
                  <p class="font-semibold text-sm" style="color: ${textColor};">${currentUser?.username}</p>
                  <p class="text-xs opacity-50" style="color: ${textColor};">${currentUser?.statusText || 'Ù…ØªØµÙ„'}</p>
                </div>
              </button>
              <button onclick="handleLogout()" class="p-2 rounded hover:bg-red-500 hover:bg-opacity-20 transition" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
                <svg class="w-5 h-5" fill="none" stroke="${textColor}" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Main Content -->
          <div class="flex-1 flex flex-col" style="background: ${bgColor};">
            ${currentChannel ? `
              <!-- Channel Header -->
              <div class="h-12 flex items-center px-4 shadow-md" style="background: ${bgColor}; border-bottom: 1px solid ${surfaceColor};">
                <span class="text-xl ml-2">#</span>
                <span class="font-bold" style="color: ${textColor};">${currentChannel.channelName}</span>
              </div>

              <!-- Messages -->
              <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                ${messages.length > 0 ? messages.map(msg => `
                  <div class="flex gap-4 message-hover p-2 rounded transition">
                    <span class="text-3xl">${allData.find(d => d.__backendId === msg.senderId)?.avatar || 'ğŸ‘¤'}</span>
                    <div>
                      <div class="flex items-center gap-2">
                        <span class="font-semibold" style="color: ${textColor};">${msg.senderName}</span>
                        <span class="text-xs opacity-50" style="color: ${textColor};">${formatTime(msg.timestamp)}</span>
                      </div>
                      <p style="color: ${textColor};">${msg.messageContent}</p>
                    </div>
                  </div>
                `).join('') : `
                  <div class="flex flex-col items-center justify-center h-full opacity-50">
                    <span class="text-6xl mb-4">ğŸ’¬</span>
                    <p style="color: ${textColor};">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©!</p>
                  </div>
                `}
              </div>

              <!-- Message Input -->
              <div class="p-4">
                <form onsubmit="event.preventDefault(); sendMessage(document.getElementById('message-input').value);" class="flex gap-2">
                  <input id="message-input" type="text" placeholder="Ø£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø©..." class="flex-1 px-4 py-3 rounded-lg focus:outline-none" style="background: #40444b; color: ${textColor};">
                  <button type="submit" class="px-6 py-3 rounded-lg font-semibold transition hover:opacity-90" style="background: ${primaryColor}; color: white;">
                    Ø¥Ø±Ø³Ø§Ù„
                  </button>
                </form>
              </div>
            ` : `
              <!-- Welcome Screen -->
              <div class="flex-1 flex flex-col items-center justify-center">
                <span class="text-8xl mb-6">ğŸ‘‹</span>
                <h2 class="text-2xl font-bold mb-2" style="color: ${textColor};">Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser?.username}!</h2>
                <p class="opacity-70 mb-6" style="color: ${textColor};">Ø§Ø®ØªØ± Ø³ÙŠØ±ÙØ± Ø£Ùˆ Ù‚Ù†Ø§Ø© Ù„Ù„Ø¨Ø¯Ø¡</p>
                ${servers.length === 0 ? `
                  <button onclick="showCreateServerModal = true; render();" class="px-6 py-3 rounded-lg font-semibold transition hover:opacity-90" style="background: ${primaryColor}; color: white;">
                    Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙŠØ±ÙØ± Ø¬Ø¯ÙŠØ¯
                  </button>
                ` : ''}
              </div>
            `}
          </div>
        </div>

        <!-- Profile Modal -->
        ${showProfileModal ? `
          <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) { showProfileModal = false; render(); }">
            <div class="w-full max-w-md rounded-2xl p-6 animate-slide" style="background: ${surfaceColor};">
              <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold" style="color: ${textColor};">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
                <button onclick="showProfileModal = false; render();" class="text-2xl opacity-70 hover:opacity-100">Ã—</button>
              </div>
              
              <div class="text-center mb-6">
                <span class="text-7xl">${currentUser?.avatar || 'ğŸ‘¤'}</span>
                <div class="mt-4">
                  <label class="text-sm opacity-70" style="color: ${textColor};">ØªØºÙŠÙŠØ± Ø§Ù„Ø£ÙØ§ØªØ§Ø±</label>
                  <div class="flex justify-center gap-2 mt-2 flex-wrap">
                    ${['ğŸ‘¤', 'ğŸ˜', 'ğŸ¤–', 'ğŸ‘¨â€ğŸ’»', 'ğŸ‘©â€ğŸ’»', 'ğŸ¦Š', 'ğŸ±', 'ğŸ¶', 'ğŸ¦', 'ğŸ¼', 'ğŸ®', 'ğŸ¯'].map(emoji => `
                      <button onclick="updateProfile('avatar', '${emoji}')" class="text-2xl p-2 rounded-lg transition hover:bg-opacity-20" style="background: ${currentUser?.avatar === emoji ? primaryColor : 'transparent'};">
                        ${emoji}
                      </button>
                    `).join('')}
                  </div>
                </div>
              </div>

              <div class="space-y-4">
                <div>
                  <label class="text-sm opacity-70" style="color: ${textColor};">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                  <input type="text" value="${currentUser?.username || ''}" onchange="updateProfile('username', this.value)" class="w-full mt-1 px-4 py-2 rounded-lg focus:outline-none" style="background: ${bgColor}; color: ${textColor};">
                </div>
                
                <div>
                  <label class="text-sm opacity-70" style="color: ${textColor};">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                  <select onchange="updateProfile('status', this.value); updateProfile('statusText', this.options[this.selectedIndex].text);" class="w-full mt-1 px-4 py-2 rounded-lg focus:outline-none" style="background: ${bgColor}; color: ${textColor};">
                    <option value="online" ${currentUser?.status === 'online' ? 'selected' : ''}>ğŸŸ¢ Ù…ØªØµÙ„</option>
                    <option value="idle" ${currentUser?.status === 'idle' ? 'selected' : ''}>ğŸŸ¡ Ø¨Ø¹ÙŠØ¯</option>
                    <option value="dnd" ${currentUser?.status === 'dnd' ? 'selected' : ''}>ğŸ”´ Ù…Ø´ØºÙˆÙ„</option>
                    <option value="offline" ${currentUser?.status === 'offline' ? 'selected' : ''}>âš« ØºÙŠØ± Ù…ØªØµÙ„</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        ` : ''}

        <!-- Create Server Modal -->
        ${showCreateServerModal ? `
          <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) { showCreateServerModal = false; render(); }">
            <div class="w-full max-w-md rounded-2xl p-6 animate-slide" style="background: ${surfaceColor};">
              <h3 class="text-xl font-bold mb-6" style="color: ${textColor};">Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙŠØ±ÙØ± Ø¬Ø¯ÙŠØ¯</h3>
              
              <form onsubmit="event.preventDefault(); createServer(this.serverName.value, this.serverIcon.value);">
                <div class="mb-4">
                  <label class="text-sm opacity-70" style="color: ${textColor};">Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ±ÙØ±</label>
                  <input type="text" name="serverName" required class="w-full mt-1 px-4 py-2 rounded-lg focus:outline-none" style="background: ${bgColor}; color: ${textColor};" placeholder="Ø³ÙŠØ±ÙØ± Ø±Ø§Ø¦Ø¹">
                </div>
                
                <div class="mb-6">
                  <label class="text-sm opacity-70" style="color: ${textColor};">Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±</label>
                  <div class="flex gap-2 mt-2 flex-wrap">
                    ${['ğŸ®', 'ğŸ¯', 'ğŸ¨', 'ğŸ“š', 'ğŸµ', 'ğŸ’»', 'ğŸŒŸ', 'ğŸš€', 'âš¡', 'ğŸ”¥'].map(emoji => `
                      <label class="cursor-pointer">
                        <input type="radio" name="serverIcon" value="${emoji}" class="hidden peer">
                        <span class="text-2xl p-2 rounded-lg block transition peer-checked:ring-2 hover:bg-opacity-20" style="background: transparent;">
                          ${emoji}
                        </span>
                      </label>
                    `).join('')}
                  </div>
                </div>
                
                <div class="flex gap-3">
                  <button type="button" onclick="showCreateServerModal = false; render();" class="flex-1 py-2 rounded-lg font-medium transition" style="background: ${bgColor}; color: ${textColor};">
                    Ø¥Ù„ØºØ§Ø¡
                  </button>
                  <button type="submit" class="flex-1 py-2 rounded-lg font-medium transition hover:opacity-90" style="background: ${primaryColor}; color: white;">
                    Ø¥Ù†Ø´Ø§Ø¡
                  </button>
                </div>
              </form>
            </div>
          </div>
        ` : ''}

        <!-- Add Friend Modal -->
        ${showAddFriendModal ? `
          <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) { showAddFriendModal = false; render(); }">
            <div class="w-full max-w-md rounded-2xl p-6 animate-slide" style="background: ${surfaceColor};">
              <h3 class="text-xl font-bold mb-6" style="color: ${textColor};">Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚</h3>
              
              <form onsubmit="event.preventDefault(); addFriend(this.friendName.value);">
                <div class="mb-6">
                  <label class="text-sm opacity-70" style="color: ${textColor};">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                  <input type="text" name="friendName" required class="w-full mt-1 px-4 py-2 rounded-lg focus:outline-none" style="background: ${bgColor}; color: ${textColor};" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                </div>
                
                <div class="flex gap-3">
                  <button type="button" onclick="showAddFriendModal = false; render();" class="flex-1 py-2 rounded-lg font-medium transition" style="background: ${bgColor}; color: ${textColor};">
                    Ø¥Ù„ØºØ§Ø¡
                  </button>
                  <button type="submit" class="flex-1 py-2 rounded-lg font-medium transition hover:opacity-90" style="background: ${primaryColor}; color: white;">
                    Ø¥Ø¶Ø§ÙØ©
                  </button>
                </div>
              </form>
            </div>
          </div>
        ` : ''}
      `;

      // Scroll to bottom of messages
      setTimeout(() => {
        const container = document.getElementById('messages-container');
        if (container) container.scrollTop = container.scrollHeight;
      }, 100);
    }

    function selectServer(serverId) {
      currentServer = getServers().find(s => s.serverId === serverId);
      const channels = getChannels(serverId);
      currentChannel = channels[0] || null;
      render();
    }

    function selectChannel(channelId) {
      const channels = currentServer ? getChannels(currentServer.serverId) : [];
      currentChannel = channels.find(c => c.channelId === channelId);
      render();
    }

    async function createChannel() {
      const name = 'Ù‚Ù†Ø§Ø©-' + Math.floor(Math.random() * 1000);
      if (allData.length >= 999) {
        showToast('ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰', 'error');
        return;
      }
      
      const result = await window.dataSdk.create({
        type: 'channel',
        channelId: generateId(),
        channelName: name,
        serverId: currentServer.serverId
      });

      if (result.isOk) {
        showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ù†Ø§Ø©!', 'success');
      }
    }

    // Initialize App
    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d32640f669e5daa',t:'MTc3MTk3MjA1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>